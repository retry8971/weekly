<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è‚¡ç¥¨æ¨èç®¡ç†</title>
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent-color: #3b82f6;
            --success-color: #22c55e;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --border-color: rgba(255, 255, 255, 0.1);
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --bg-gradient-1: rgba(59, 130, 246, 0.1);
            --bg-gradient-2: rgba(16, 185, 129, 0.1);
        }

        [data-theme="light"] {
            --bg-color: #f1f5f9;
            --card-bg: rgba(255, 255, 255, 0.9);
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: rgba(0, 0, 0, 0.1);
            --glass-border: 1px solid rgba(0, 0, 0, 0.1);
            --bg-gradient-1: rgba(59, 130, 246, 0.05);
            --bg-gradient-2: rgba(16, 185, 129, 0.05);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* Hide number input spinners */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
        }

        html {
            overscroll-behavior: none;
            overflow: hidden;
            height: 100%;
            touch-action: manipulation;
            background-color: var(--bg-color);
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color);
            background-image:
                radial-gradient(circle at 10% 20%, var(--bg-gradient-1) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, var(--bg-gradient-2) 0%, transparent 40%);
            background-attachment: fixed;
            color: var(--text-primary);
            height: 100%;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1.5rem 1rem;
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            animation: fadeInDown 0.6s ease-out;
        }

        .top-bar h1 {
            font-size: 1.5rem;
            background: linear-gradient(to right, #60a5fa, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.025em;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .nav-btn {
            background: var(--card-bg);
            border: var(--glass-border);
            color: var(--text-primary);
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            cursor: pointer;
            text-decoration: none;
            font-size: 1rem;
            line-height: 1;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .nav-btn:hover {
            background: var(--bg-gradient-1);
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: .5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
        }

        .card h2 {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: var(--text-secondary);
        }

        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .form-group label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        input,
        textarea,
        select {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.5rem 0.8rem;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        textarea {
            min-height: 150px;
            resize: vertical;
            width: 100%;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: opacity 0.2s;
        }

        .btn:hover {
            opacity: 0.85;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--accent-color);
            color: white;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-warning {
            background: var(--warning-color);
            color: #000;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .week-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .week-item {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 6px;
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .week-item:hover {
            background: rgba(59, 130, 246, 0.3);
        }

        .week-item.active {
            background: var(--accent-color);
            border-color: var(--accent-color);
        }

        .status {
            padding: 0.8rem;
            border-radius: 6px;
            margin-top: 1rem;
            font-size: 0.85rem;
        }

        .status.success {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success-color);
        }

        .status.error {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger-color);
        }

        .status.info {
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent-color);
        }

        .stock-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            margin-top: 1rem;
            table-layout: fixed;
        }

        .stock-table th,
        .stock-table td {
            padding: 0.6rem 0.4rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .stock-table th {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .stock-table td:nth-child(4) {
            white-space: normal;
        }

        .positive {
            color: var(--danger-color);
        }

        .negative {
            color: var(--success-color);
        }

        .loading {
            text-align: center;
            color: var(--text-secondary);
        }

        /* ç¼–è¾‘å¼¹çª— */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            width: 90%;
            max-width: 450px;
        }

        .modal h3 {
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .modal .form-group {
            margin-bottom: 0.8rem;
        }

        .modal .form-group label {
            display: block;
            margin-bottom: 0.3rem;
        }

        .modal input,
        .modal textarea {
            width: 100%;
        }

        .modal textarea {
            min-height: 80px;
        }

        .modal-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            margin-top: 1rem;
        }

        /* å°æŒ‰é’® */
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        .action-btns {
            display: flex;
            gap: 0.3rem;
        }

        @media (max-width: 600px) {
            .form-row {
                flex-direction: column;
            }

            /* ä¼˜åŒ–å‘¨é€‰æ‹©å¸ƒå±€ */
            .form-row.week-select-row {
                flex-direction: row;
                align-items: flex-end;
                gap: 0.5rem;
            }

            .week-select-row .form-group {
                flex: 0 0 auto;
            }

            .week-select-row .form-group label {
                font-size: 0.75rem;
            }

            .week-select-row button {
                padding: 0.5rem 0.8rem;
            }

            /* å¼¹çª—ä¼˜åŒ– */
            .stock-code-row {
                flex-direction: row !important;
                gap: 0.5rem;
            }

            .stock-code-row .form-group label {
                font-size: 0.75rem;
            }

            .btn-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            /* ç§»åŠ¨ç«¯å¡ç‰‡å¼å¸ƒå±€ - ç´§å‡‘ç‰ˆ */
            .stock-table {
                display: block;
                margin-top: 0.5rem;
            }

            .stock-table thead {
                display: none !important;
            }

            .stock-table tbody {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }

            .stock-table tr {
                display: flex;
                flex-wrap: wrap;
                align-items: center;
                padding: 0.75rem;
                background: var(--card-bg);
                border: 1px solid var(--border-color);
                border-radius: 8px;
                position: relative;
            }

            .stock-table td {
                border: none;
                padding: 0;
                white-space: normal;
            }

            /* åºå· - éšè— */
            .stock-table td:first-child {
                display: none;
            }

            /* è‚¡ç¥¨åç§° */
            .stock-table td:nth-child(2) {
                order: 1;
                font-weight: 600;
                font-size: 1rem;
                color: var(--text-primary);
                margin-right: 0.5rem;
            }

            /* ä»£ç  */
            .stock-table td:nth-child(3) {
                order: 2;
                display: inline-block !important;
                /* å¼ºåˆ¶æ˜¾ç¤º */
                font-size: 0.85rem;
                color: var(--text-secondary);
            }

            /* æ¶¨è·Œå¹… - æ”¾åˆ°å³ä¾§ï¼Œä½†åœ¨æŒ‰é’®å·¦è¾¹ */
            .stock-table td:nth-child(5) {
                order: 3;
                margin-left: auto;
                margin-right: 0.5rem;
                font-weight: 600;
                font-size: 0.9rem;
            }

            /* æ“ä½œæŒ‰é’® - ç»å¯¹å®šä½å³ä¸Šè§’æˆ–è€…Flexæœ«å°¾ */
            /* ä¸ºäº†æœ€èŠ‚çœç©ºé—´ï¼Œä½¿ç”¨ Flex æœ«å°¾ï¼Œä½†å¦‚æœå¤ªæŒ¤åˆ™æ¢è¡Œ */
            /* ç”¨æˆ·å»ºè®®ï¼štop right */
            .stock-table td:last-child {
                /* ä½¿ç”¨ç»å¯¹å®šä½å›ºå®šåœ¨å³ä¸Šè§’ï¼ŒèŠ‚çœè¡Œå†…ç©ºé—´ */
                position: absolute;
                top: 0.6rem;
                right: 0.6rem;
            }

            /* è¿™ç§æƒ…å†µä¸‹ï¼Œæ¶¨è·Œå¹…éœ€è¦é¿å¼€æŒ‰é’®åŒºåŸŸ */
            /* æˆ–è€…ï¼Œè®©æŒ‰é’®è·Ÿéšæµï¼Ÿ */
            /* è®©æˆ‘ä»¬è¯•è¯•æµå¼å¸ƒå±€ + å°æŒ‰é’® */

            /* ä¿®æ”¹æ–¹æ¡ˆï¼šä¸åšç»å¯¹å®šä½ï¼Œè€Œæ˜¯æµå¼å¸ƒå±€ */
            /* è¦†ç›–ä¸Šé¢çš„ absolute */
            .stock-table td:last-child {
                order: 4;
                position: static;
                margin-left: 0;
            }

            /* è°ƒæ•´æŒ‰é’®å¤§å° */
            .action-btns .btn-sm {
                padding: 0.2rem 0.5rem;
                font-size: 0.75rem;
            }

            /* æ¨èäºº - æ¢è¡Œ */
            .stock-table td:nth-child(4) {
                order: 5;
                width: 100%;
                margin-top: 0.4rem;
                font-size: 0.8rem;
                color: var(--text-secondary);
                line-height: 1.3;
                border-top: 1px solid rgba(255, 255, 255, 0.05);
                padding-top: 0.3rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="top-bar">
            <h1>ADMIN PANEL</h1>
            <div class="controls">
                <a href="ranking.html" class="nav-btn" title="æ’è¡Œæ¦œ">ğŸ†</a>
                <a href="recommender.html" class="nav-btn" title="æ¨èäºº">ğŸ‘¥</a>
                <a href="stocks.html" class="nav-btn" title="è‚¡ç¥¨è·Ÿè¸ª">ğŸ“ˆ</a>
                <button class="nav-btn" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ“</button>
            </div>
        </div>

        <!-- å‘¨é€‰æ‹© -->
        <div class="card">
            <h2>ğŸ“… é€‰æ‹©å‘¨ <span id="weekDateRange"
                    style="font-size:0.9rem;color:var(--text-secondary);font-weight:normal;margin-left:0.5rem"></span>
            </h2>
            <div class="form-row week-select-row">
                <div class="form-group">
                    <label>å¹´ä»½</label>
                    <input type="number" id="yearInput" style="width: 60px;">
                </div>
                <div class="form-group">
                    <label>å‘¨æ•°</label>
                    <div style="display:flex;align-items:center;gap:2px">
                        <button class="btn btn-sm" onclick="changeWeek(-1)" style="padding:0.4rem 0.6rem">â€¹</button>
                        <input type="number" id="weekInput" style="width: 50px;text-align:center" min="1" max="53">
                        <button class="btn btn-sm" onclick="changeWeek(1)" style="padding:0.4rem 0.6rem">â€º</button>
                    </div>
                </div>
                <div class="form-group" style="justify-content: flex-end;">
                    <button class="btn btn-primary" onclick="selectWeek()">Go</button>
                </div>
            </div>
            <div id="weekList" class="week-list"></div>
        </div>

        <!-- åŸå§‹æ–‡æœ¬ -->
        <div class="card">
            <details>
                <summary style="display:flex;align-items:center;cursor:pointer;list-style:none;outline:none">
                    <h2 style="margin:0;flex:1">ğŸ“ æ¨èåŸå§‹æ–‡æœ¬</h2>
                    <span style="opacity:0.5;transform:rotate(90deg);font-size:1.2rem">â€º</span>
                </summary>
                <div style="margin-top:1rem">
                    <textarea id="rawText" placeholder="ç²˜è´´æ¨èåŸå§‹æ–‡æœ¬..."></textarea>
                    <div class="btn-group" style="margin-top: 1rem;">
                        <button class="btn btn-primary" onclick="saveRawText()">ä¿å­˜æ–‡æœ¬</button>
                        <button class="btn" onclick="copyRawText()">å¤åˆ¶æ–‡æœ¬</button>
                    </div>
                </div>
            </details>
        </div>
        <style>
            summary::-webkit-details-marker {
                display: none;
            }

            details[open] summary span {
                transform: rotate(270deg) !important;
            }
        </style>

        <!-- æ“ä½œ -->
        <div class="card">
            <h2>âš¡ æ“ä½œ</h2>
            <div class="btn-group">
                <button class="btn btn-warning" onclick="parseWithGemini()">Geminiè§£æ</button>
                <button class="btn btn-success" onclick="resolveCodes()">å¡«å……ä»£ç </button>
                <button class="btn btn-primary" onclick="fetchKline()">åŒæ­¥è‚¡ä»·</button>
                <button class="btn btn-success" onclick="recalculateStats()">é‡ç®—ç»Ÿè®¡</button>
                <button class="btn btn-danger" onclick="deleteWeek()">åˆ é™¤æœ¬å‘¨</button>
            </div>
            <div id="statusArea"></div>
        </div>

        <!-- è‚¡ç¥¨åˆ—è¡¨ -->
        <div class="card">
            <h2>ğŸ“ˆ è‚¡ç¥¨åˆ—è¡¨</h2>
            <div id="stockList" class="loading">é€‰æ‹©ä¸€å‘¨æŸ¥çœ‹æ•°æ®</div>
        </div>
    </div>

    <!-- ç¼–è¾‘è‚¡ç¥¨å¼¹çª— -->
    <div id="editModal" class="modal-overlay" onclick="closeEditModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <h3>âœ¨ ç¼–è¾‘è‚¡ç¥¨</h3>
            <input type="hidden" id="editOldStockName">
            <div class="form-group">
                <label>è‚¡ç¥¨åç§°</label>
                <div style="display:flex;gap:0.5rem">
                    <input type="text" id="editStockName" style="flex:1;width:auto;min-width:0">
                    <button class="btn btn-sm btn-primary" onclick="guessStockCode()"
                        style="white-space:nowrap;width:auto">çŒœä¸€ä¸‹</button>
                </div>
            </div>
            <div class="form-row stock-code-row">
                <div class="form-group" style="flex:1">
                    <label>å¸‚åœº</label>
                    <select id="editMarket">
                        <option value="">--</option>
                        <option value="SH">SH</option>
                        <option value="SZ">SZ</option>
                        <option value="BJ">BJ</option>
                        <option value="HK">HK</option>
                    </select>
                </div>
                <div class="form-group" style="flex:2">
                    <label>è‚¡ç¥¨ä»£ç </label>
                    <input type="text" id="editStockCode" oninput="autoSelectMarket(this.value)">
                </div>
            </div>
            <div class="form-group">
                <label>æ¨èäººï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</label>
                <textarea id="editRecommenders" placeholder="æ¯è¡Œä¸€ä¸ªæ¨èäºº"></textarea>
            </div>
            <div id="editStatus" style="font-size:0.8rem;min-height:1.2rem;color:var(--text-secondary)"></div>
            <div class="modal-actions">
                <button class="btn" onclick="closeEditModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveStockEdit()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        // ä¸»é¢˜åˆ‡æ¢
        function toggleTheme() {
            const html = document.documentElement;
            const current = html.getAttribute('data-theme');
            const next = current === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', next === 'dark' ? '' : next);
            localStorage.setItem('theme', next);
        }

        // åˆå§‹åŒ–ä¸»é¢˜
        (function () {
            const saved = localStorage.getItem('theme');
            if (saved === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
            }
        })();

        let currentYear = null;
        let currentWeek = null;
        let reportMap = new Map(); // code -> url

        // è§£æURL hash (æ ¼å¼: #2025-W51)
        function parseHash() {
            const hash = window.location.hash.slice(1);
            if (hash) {
                const match = hash.match(/^(\d{4})-W?(\d{1,2})$/i);
                if (match) {
                    return { year: parseInt(match[1]), week: parseInt(match[2]) };
                }
            }
            return null;
        }

        // æ›´æ–°URL hash
        function updateHash() {
            const newHash = `${currentYear}-W${currentWeek}`;
            if (window.location.hash !== `#${newHash}`) {
                history.replaceState(null, '', `#${newHash}`);
            }
            updateWeekRangeDisplay();
        }

        // æ›´æ–°å‘¨æ—¥æœŸèŒƒå›´æ˜¾ç¤º
        function updateWeekRangeDisplay() {
            const el = document.getElementById('weekDateRange');
            if (currentYear && currentWeek && el) {
                el.textContent = `(${getWeekDateRange(currentYear, currentWeek)})`;
            } else if (el) {
                el.textContent = '';
            }
        }

        // åˆå§‹åŒ–
        // åˆ‡æ¢å‘¨
        function changeWeek(offset) {
            let y = parseInt(document.getElementById('yearInput').value);
            let w = parseInt(document.getElementById('weekInput').value);
            w += offset;

            // Simple logic: assume 52 weeks mostly. 
            // If going forward from 52, check if 53 exists? 
            // For simplicity: if > 52 -> next year week 1. 
            // If user needs week 53, they can type it or we can be smarter later.
            // Actually, let's allow going up to 53 if we are at 52? 
            // No, let's just loop at 52 for standard behavior 
            // or just let it go to 53 then 1.
            if (w > 53) {
                y++;
                w = 1;
            } else if (w < 1) {
                y--;
                w = 52;
            }

            document.getElementById('yearInput').value = y;
            document.getElementById('weekInput').value = w;
            selectWeek();
        }

        async function init() {
            // ä¼˜å…ˆä»hashè¯»å–
            const hashData = parseHash();
            if (hashData) {
                currentYear = hashData.year;
                currentWeek = hashData.week;
            } else {
                // è·å–å½“å‰å‘¨
                const res = await fetch('/api/admin/current-week');
                const data = await res.json();
                currentYear = data.data.year;
                currentWeek = data.data.week;
            }

            document.getElementById('yearInput').value = currentYear;
            document.getElementById('weekInput').value = currentWeek;
            updateHash();

            document.getElementById('weekInput').value = currentWeek;
            updateHash();

            await fetchReportCodes();
            await loadWeekList();
            await loadWeekData();
            updateWeekRangeDisplay();
        }

        // ç›‘å¬hashå˜åŒ–
        window.addEventListener('hashchange', () => {
            const hashData = parseHash();
            if (hashData && (hashData.year !== currentYear || hashData.week !== currentWeek)) {
                currentYear = hashData.year;
                currentWeek = hashData.week;
                document.getElementById('yearInput').value = currentYear;
                document.getElementById('weekInput').value = currentWeek;
                loadWeekData();
                loadWeekList();
                updateWeekRangeDisplay();
            }
        });

        function getWeekDateRange(year, week) {
            // ISOå‘¨ï¼šå‘¨ä¸€æ˜¯ç¬¬ä¸€å¤©ï¼Œç¬¬ä¸€å‘¨åŒ…å«è¯¥å¹´ç¬¬ä¸€ä¸ªå‘¨å››
            // ä½¿ç”¨ç®€å•ç®—æ³•ï¼šå…ˆæ‰¾åˆ°å½“å¹´1æœˆ4æ—¥ï¼ˆä¸€å®šåœ¨ç¬¬ä¸€å‘¨ï¼‰ï¼Œ
            // ç„¶åæ‰¾åˆ°è¯¥å‘¨çš„å‘¨ä¸€ï¼Œå†åŠ ä¸Š(week-1)*7å¤©
            const jan4 = new Date(year, 0, 4);
            const dayOfWeek = jan4.getDay() || 7; // å‘¨æ—¥è½¬ä¸º7
            const firstMonday = new Date(jan4.getTime() - (dayOfWeek - 1) * 24 * 60 * 60 * 1000);

            const weekStart = new Date(firstMonday.getTime() + (week - 1) * 7 * 24 * 60 * 60 * 1000);
            const weekEnd = new Date(weekStart.getTime() + 6 * 24 * 60 * 60 * 1000);

            const formatDate = (d) => `${d.getMonth() + 1}/${d.getDate()}`;
            return `${formatDate(weekStart)}~${formatDate(weekEnd)}`;
        }

        // è·å–ç ”æŠ¥åˆ—è¡¨
        async function fetchReportCodes() {
            try {
                const res = await fetch('/api/reports');
                const data = await res.json();
                const reports = data.data || [];
                reportMap = new Map(reports.map(r => {
                    const url = r.type === 'link' ? r.url : `/reports/${r.filename}`;
                    return [r.stock_code, url];
                }));
            } catch (e) {
                console.warn('è·å–ç ”æŠ¥åˆ—è¡¨å¤±è´¥:', e);
            }
        }

        // åŠ è½½å‘¨åˆ—è¡¨
        async function loadWeekList() {
            const res = await fetch('/api/admin/weeks');
            const data = await res.json();
            const weeks = data.data || [];

            const container = document.getElementById('weekList');
            container.innerHTML = weeks.map(w => {
                const dateRange = getWeekDateRange(w.year, w.week);
                return `
                <div class="week-item ${w.year === currentYear && w.week === currentWeek ? 'active' : ''}" 
                     onclick="selectWeekItem(${w.year}, ${w.week})"
                     title="${w.year}-W${w.week} (${dateRange})">
                    ${w.year}-W${w.week}
                </div>
            `}).join('');
        }

        // é€‰æ‹©å‘¨
        function selectWeek() {
            currentYear = parseInt(document.getElementById('yearInput').value);
            currentWeek = parseInt(document.getElementById('weekInput').value);
            updateHash();
            loadWeekData();
            loadWeekList();
        }

        function selectWeekItem(year, week) {
            currentYear = year;
            currentWeek = week;
            document.getElementById('yearInput').value = year;
            document.getElementById('weekInput').value = week;
            updateHash();
            loadWeekData();
            loadWeekList();
        }

        // åŠ è½½å‘¨æ•°æ®
        async function loadWeekData() {
            if (!currentYear || !currentWeek) return;

            showStatus('info', 'åŠ è½½ä¸­...');

            try {
                const res = await fetch(`/api/admin/week/${currentYear}/${currentWeek}`);
                const data = await res.json();
                const weekData = data.data || {};

                // å¡«å……åŸå§‹æ–‡æœ¬
                document.getElementById('rawText').value = weekData.raw_text || '';

                // æ˜¾ç¤ºè‚¡ç¥¨åˆ—è¡¨
                renderStockList(weekData.stocks || []);

                clearStatus();
            } catch (e) {
                showStatus('error', 'åŠ è½½å¤±è´¥: ' + e.message);
            }
        }

        // æ¸²æŸ“è‚¡ç¥¨åˆ—è¡¨
        function renderStockList(stocks) {
            const container = document.getElementById('stockList');

            if (!stocks.length) {
                container.innerHTML = '<div class="loading">æš‚æ— æ•°æ®</div>';
                return;
            }

            // ä¿å­˜åˆ°å…¨å±€ç”¨äºç¼–è¾‘
            window.currentStocks = stocks;

            container.innerHTML = `
                <table class="stock-table">
                    <thead>
                        <tr>
                            <th style="width:3rem">#</th>
                            <th style="width:6rem">è‚¡ç¥¨</th>
                            <th style="width:5.5rem">ä»£ç </th>
                            <th>æ¨èäºº</th>
                            <th style="width:4rem">æ¶¨è·Œå¹…</th>
                            <th style="width:6rem">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${stocks.map((s, idx) => {
                            const reportUrl = s.stock_code ? reportMap.get(s.stock_code) : null;
                            const reportIcon = reportUrl ? `
                                <a href="${reportUrl}" target="_blank" title="æŸ¥çœ‹ç ”æŠ¥" 
                                   style="margin-left:0.3rem; display:inline-flex; align-items:center; color:var(--accent-color); opacity:0.8; text-decoration:none;">
                                    <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                        <polyline points="14 2 14 8 20 8"></polyline>
                                        <line x1="16" y1="13" x2="8" y2="13"></line>
                                        <line x1="16" y1="17" x2="8" y2="17"></line>
                                        <polyline points="10 9 9 9 8 9"></polyline>
                                    </svg>
                                </a>` : '';
                            return `
                            <tr>
                                <td style="color:var(--text-secondary)">${idx + 1}</td>
                                <td>
                                    <div style="display:flex;align-items:center">
                                        ${s.stock_name || '-'}${reportIcon}
                                    </div>
                                </td>
                                <td>${s.market || ''}${s.stock_code || '-'}</td>
                                <td>${(s.recommenders || []).join(', ')}</td>
                                <td class="${(s.change_pct || 0) >= 0 ? 'positive' : 'negative'}">
                                    ${s.change_pct != null ? s.change_pct.toFixed(2) + '%' : '-'}
                                </td>
                                <td>
                                    <div class="action-btns">
                                        <button class="btn btn-sm btn-primary" onclick="openEditModal(${idx})">ç¼–è¾‘</button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteStock('${s.stock_name.replace(/'/g, "\\'")}')">åˆ é™¤</button>
                                    </div>
                                </td>
                            </tr>
                        `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        // ä¿å­˜åŸå§‹æ–‡æœ¬
        async function saveRawText() {
            const rawText = document.getElementById('rawText').value;
            if (!rawText) {
                showStatus('error', 'è¯·è¾“å…¥åŸå§‹æ–‡æœ¬');
                return;
            }

            showStatus('info', 'ä¿å­˜ä¸­...');

            try {
                const res = await fetch('/api/admin/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ year: currentYear, week: currentWeek, raw_text: rawText })
                });
                const data = await res.json();

                if (data.error) {
                    showStatus('error', data.error);
                } else {
                    showStatus('success', 'ä¿å­˜æˆåŠŸ');
                    await loadWeekList();
                }
            } catch (e) {
                showStatus('error', 'ä¿å­˜å¤±è´¥: ' + e.message);
            }
        }

        async function copyRawText() {
            const text = document.getElementById('rawText').value;
            if (!text) return showStatus('error', 'æ²¡æœ‰æ–‡æœ¬');

            try {
                // Try modern API
                await navigator.clipboard.writeText(text);
                showStatus('success', 'å·²å¤åˆ¶');
            } catch (err) {
                // Fallback for insecure context or older browsers
                try {
                    const textArea = document.getElementById('rawText');
                    textArea.select();
                    textArea.setSelectionRange(0, 99999); // For mobile
                    document.execCommand('copy');
                    showStatus('success', 'å·²å¤åˆ¶ (å…¼å®¹æ¨¡å¼)');
                    // Deselect
                    if (window.getSelection) {
                        window.getSelection().removeAllRanges();
                    }
                    textArea.blur();
                } catch (e) {
                    showStatus('error', 'å¤åˆ¶å¤±è´¥');
                }
            }
        }

        // Geminiè§£æ
        async function parseWithGemini() {
            showStatus('info', 'Geminiè§£æä¸­...');

            try {
                const res = await fetch('/api/admin/parse', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ year: currentYear, week: currentWeek })
                });
                const data = await res.json();

                if (data.error) {
                    showStatus('error', data.error);
                } else {
                    showStatus('success', `è§£æå®Œæˆ: ${data.data.stocks_count} åªè‚¡ç¥¨`);
                    await loadWeekData();
                }
            } catch (e) {
                showStatus('error', 'è§£æå¤±è´¥: ' + e.message);
            }
        }

        // å¡«å……ä»£ç 
        async function resolveCodes() {
            showStatus('info', 'å¡«å……è‚¡ç¥¨ä»£ç ä¸­...');

            try {
                const res = await fetch('/api/admin/resolve-codes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ year: currentYear, week: currentWeek })
                });
                const data = await res.json();

                if (data.error) {
                    showStatus('error', data.error);
                } else {
                    showStatus('success', `å¡«å……å®Œæˆ: æˆåŠŸ${data.data.success}, å¤±è´¥${data.data.error}`);
                    await loadWeekData();
                }
            } catch (e) {
                showStatus('error', 'å¡«å……å¤±è´¥: ' + e.message);
            }
        }

        // è·å–Kçº¿
        async function fetchKline() {
            showStatus('info', 'è·å–Kçº¿æ•°æ®ä¸­...');

            try {
                const res = await fetch('/api/admin/fetch-kline', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ year: currentYear, week: currentWeek })
                });
                const data = await res.json();

                if (data.error) {
                    showStatus('error', data.error);
                } else {
                    showStatus('success', `è·å–å®Œæˆ: æˆåŠŸ${data.data.success}, å¤±è´¥${data.data.error}`);
                    await loadWeekData();
                }
            } catch (e) {
                showStatus('error', 'è·å–å¤±è´¥: ' + e.message);
            }
        }

        // é‡ç®—ç»Ÿè®¡
        async function recalculateStats() {
            showStatus('info', 'é‡æ–°è®¡ç®—ç»Ÿè®¡ä¸­...');

            try {
                const res = await fetch('/api/admin/recalculate-stats', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const data = await res.json();

                if (data.error) {
                    showStatus('error', data.error);
                } else {
                    showStatus('success', `ç»Ÿè®¡å®Œæˆ: ${data.data.count} ä½æ¨èäºº`);
                }
            } catch (e) {
                showStatus('error', 'è®¡ç®—å¤±è´¥: ' + e.message);
            }
        }

        // åˆ é™¤æœ¬å‘¨
        async function deleteWeek() {
            if (!confirm(`ç¡®å®šåˆ é™¤ ${currentYear} å¹´ç¬¬ ${currentWeek} å‘¨æ•°æ®?`)) return;

            showStatus('info', 'åˆ é™¤ä¸­...');

            try {
                const res = await fetch('/api/admin/delete-week', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ year: currentYear, week: currentWeek })
                });
                const data = await res.json();

                if (data.error) {
                    showStatus('error', data.error);
                } else {
                    showStatus('success', 'åˆ é™¤æˆåŠŸ');
                    await loadWeekList();
                    await loadWeekData();
                }
            } catch (e) {
                showStatus('error', 'åˆ é™¤å¤±è´¥: ' + e.message);
            }
        }

        // çŠ¶æ€æ˜¾ç¤º
        function showStatus(type, message) {
            document.getElementById('statusArea').innerHTML = `
                <div class="status ${type}">${message}</div>
            `;
        }

        function clearStatus() {
            document.getElementById('statusArea').innerHTML = '';
        }

        // ========== ç¼–è¾‘è‚¡ç¥¨å¼¹çª— ==========

        // æ ¹æ®è‚¡ç¥¨ä»£ç è‡ªåŠ¨é€‰æ‹©å¸‚åœº
        function autoSelectMarket(code) {
            if (!code || code.length < 2) return;

            const prefix = code.substring(0, 3);
            const prefix2 = code.substring(0, 2);
            let market = '';

            // ä¸Šäº¤æ‰€: 600/601/603/605 (ä¸»æ¿), 688 (ç§‘åˆ›æ¿)
            if (/^(600|601|603|605|688)/.test(code)) {
                market = 'SH';
            }
            // æ·±äº¤æ‰€: 000/001/002 (ä¸»æ¿), 300 (åˆ›ä¸šæ¿)
            else if (/^(000|001|002|003|300|301)/.test(code)) {
                market = 'SZ';
            }
            // åŒ—äº¤æ‰€: 8xx, 43x
            else if (/^(8|43)/.test(code)) {
                market = 'BJ';
            }

            if (market) {
                document.getElementById('editMarket').value = market;
            }
        }

        // çŒœä¸€ä¸‹ï¼šæ ¹æ®è‚¡ç¥¨åç§°è‡ªåŠ¨å¡«å……ä»£ç å’Œå¸‚åœº
        async function guessStockCode() {
            const stockName = document.getElementById('editStockName').value.trim();
            const statusEl = document.getElementById('editStatus');

            if (!stockName) {
                statusEl.innerHTML = '<span style="color:var(--danger-color)">è¯·å…ˆè¾“å…¥è‚¡ç¥¨åç§°</span>';
                return;
            }

            statusEl.innerHTML = 'æœç´¢ä¸­...';

            try {
                const res = await fetch(`/api/admin/search-stock?name=${encodeURIComponent(stockName)}`);
                const data = await res.json();

                if (data.error) {
                    statusEl.innerHTML = `<span style="color:var(--danger-color)">${data.error}</span>`;
                } else if (data.data) {
                    document.getElementById('editMarket').value = data.data.market || '';
                    document.getElementById('editStockCode').value = data.data.code || '';
                    if (data.data.name && data.data.name !== stockName) {
                        document.getElementById('editStockName').value = data.data.name;
                    }
                    statusEl.innerHTML = `<span style="color:var(--success-color)">âœ“ ${data.data.market}${data.data.code} ${data.data.name || ''}</span>`;
                } else {
                    statusEl.innerHTML = '<span style="color:var(--danger-color)">æœªæ‰¾åˆ°è¯¥è‚¡ç¥¨</span>';
                }
            } catch (e) {
                statusEl.innerHTML = `<span style="color:var(--danger-color)">æœç´¢å¤±è´¥: ${e.message}</span>`;
            }
        }

        function openEditModal(idx) {
            const stock = window.currentStocks[idx];
            if (!stock) return;

            document.getElementById('editOldStockName').value = stock.stock_name || '';
            document.getElementById('editStockName').value = stock.stock_name || '';
            document.getElementById('editMarket').value = (stock.market || '').toUpperCase();
            document.getElementById('editStockCode').value = stock.stock_code || '';
            document.getElementById('editRecommenders').value = (stock.recommenders || []).join('\n');
            document.getElementById('editStatus').innerHTML = '';

            document.getElementById('editModal').classList.add('visible');
        }

        function closeEditModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('editModal').classList.remove('visible');
        }

        async function saveStockEdit() {
            const oldStockName = document.getElementById('editOldStockName').value;
            const newData = {
                stock_name: document.getElementById('editStockName').value.trim(),
                market: document.getElementById('editMarket').value,
                stock_code: document.getElementById('editStockCode').value.trim(),
                recommenders: document.getElementById('editRecommenders').value
                    .split('\n')
                    .map(s => s.trim())
                    .filter(s => s)
            };

            if (!newData.stock_name) {
                showStatus('error', 'è‚¡ç¥¨åç§°ä¸èƒ½ä¸ºç©º');
                return;
            }

            showStatus('info', 'ä¿å­˜ä¸­...');

            try {
                const res = await fetch('/api/admin/update-stock', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        year: currentYear,
                        week: currentWeek,
                        old_stock_name: oldStockName,
                        new_data: newData
                    })
                });
                const data = await res.json();

                if (data.error) {
                    showStatus('error', data.error);
                } else if (data.data.updated) {
                    showStatus('success', 'ä¿®æ”¹æˆåŠŸ');
                    closeEditModal();
                    await loadWeekData();
                } else {
                    showStatus('error', 'æœªæ‰¾åˆ°è¯¥è‚¡ç¥¨');
                }
            } catch (e) {
                showStatus('error', 'ä¿å­˜å¤±è´¥: ' + e.message);
            }
        }

        async function deleteStock(stockName) {
            if (!confirm(`ç¡®å®šåˆ é™¤è‚¡ç¥¨ã€Œ${stockName}ã€?`)) return;

            showStatus('info', 'åˆ é™¤ä¸­...');

            try {
                const res = await fetch('/api/admin/delete-stock', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        year: currentYear,
                        week: currentWeek,
                        stock_name: stockName
                    })
                });
                const data = await res.json();

                if (data.error) {
                    showStatus('error', data.error);
                } else if (data.data.deleted) {
                    showStatus('success', 'åˆ é™¤æˆåŠŸ');
                    await loadWeekData();
                } else {
                    showStatus('error', 'æœªæ‰¾åˆ°è¯¥è‚¡ç¥¨');
                }
            } catch (e) {
                showStatus('error', 'åˆ é™¤å¤±è´¥: ' + e.message);
            }
        }

        // å¯åŠ¨
        init();
    </script>
</body>

</html>