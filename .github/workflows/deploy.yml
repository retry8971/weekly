name: Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Debug connection
        env:
          SSH_HOST: ${{ secrets.DEPLOY_HOST }}
          SSH_PASS: ${{ secrets.DEPLOY_PASSWORD }}
        run: |
          echo "=== Debug Info ==="
          echo "SSH_HOST value: [${SSH_HOST}]"
          echo "SSH_HOST length: ${#SSH_HOST}"
          echo "SSH_PASS length: ${#SSH_PASS}"
          
      - name: Deploy via SSH
        env:
          SSH_HOST: ${{ secrets.DEPLOY_HOST }}
          SSH_PASS: ${{ secrets.DEPLOY_PASSWORD }}
        run: |
          # 安装 sshpass
          sudo apt-get update && sudo apt-get install -y sshpass
          
          # SSH 到服务器执行部署命令
          sshpass -p "${SSH_PASS}" ssh -o StrictHostKeyChecking=no root@${SSH_HOST} << 'EOF'
            cd /root/weekly
            git pull
            supervisorctl restart weekly
          EOF

  deploy-vercel:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'

